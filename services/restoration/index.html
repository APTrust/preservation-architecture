



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Restoration - APTrust Preservation Services Architecture</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#restoration" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="APTrust Preservation Services Architecture" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              APTrust Preservation Services Architecture
            </span>
            <span class="md-header-nav__topic">
              
                Restoration
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/APTrust/services-architecture/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="APTrust Preservation Services Architecture" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    APTrust Preservation Services Architecture
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/APTrust/services-architecture/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Ingest
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Ingest
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/bucket_reader/" title="Bucket Reader" class="md-nav__link">
      Bucket Reader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/pre_fetch/" title="Pre-Fetch" class="md-nav__link">
      Pre-Fetch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/validation/" title="Validation" class="md-nav__link">
      Validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/reingest_check/" title="Reingest Check" class="md-nav__link">
      Reingest Check
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/staging/" title="Copy to Staging" class="md-nav__link">
      Copy to Staging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/format_identification/" title="Format Identification" class="md-nav__link">
      Format Identification
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/storage/" title="Copy to Preservation" class="md-nav__link">
      Copy to Preservation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/storage_validation/" title="Storage Validation" class="md-nav__link">
      Storage Validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/metadata_recording/" title="Metadata Recording" class="md-nav__link">
      Metadata Recording
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ingest/cleanup/" title="Cleanup" class="md-nav__link">
      Cleanup
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fixity/" title="Fixity Checking" class="md-nav__link">
      Fixity Checking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deletion/" title="Deletion" class="md-nav__link">
      Deletion
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Restoration
      </label>
    
    <a href="./" title="Restoration" class="md-nav__link md-nav__link--active">
      Restoration
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#restoring-files" title="Restoring Files" class="md-nav__link">
    Restoring Files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restoring-objects" title="Restoring Objects" class="md-nav__link">
    Restoring Objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restoring-from-glacier" title="Restoring from Glacier" class="md-nav__link">
    Restoring from Glacier
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Scaling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Scaling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../scaling/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Components
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Components
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/receiving/" title="Receiving" class="md-nav__link">
      Receiving
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/restoration/" title="Restoration" class="md-nav__link">
      Restoration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/preservation/" title="Preservation" class="md-nav__link">
      Preservation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/pharos/" title="Pharos" class="md-nav__link">
      Pharos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/rds/" title="Postgres RDS Database" class="md-nav__link">
      Postgres RDS Database
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/nsq/" title="NSQ" class="md-nav__link">
      NSQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../components/redis/" title="Redis" class="md-nav__link">
      Redis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#restoring-files" title="Restoring Files" class="md-nav__link">
    Restoring Files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restoring-objects" title="Restoring Objects" class="md-nav__link">
    Restoring Objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restoring-from-glacier" title="Restoring from Glacier" class="md-nav__link">
    Restoring from Glacier
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/APTrust/services-architecture/edit/master/docs/services/restoration.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="restoration">Restoration</h1>
<p>Depositors can request restoration of files or objects through the Pharos Web UI. Clicking the <strong>Restore</strong> button for a file restores a single file; for an object, it restores all files belonging to that object in BagIt format.</p>
<p>When the user clicks <strong>Restore</strong>:</p>
<ol>
<li>Pharos creates a WorkItem saying that user X has requested restoration of file or object Y.</li>
<li>The <code>apt_queue</code> cron job, which runs every 10 minutes or so, copies the WorkItem ID of the restoration request into the appropriate topic in NSQ.</li>
<li>NSQ passes the WorkItem ID to a worker to fulfill the request.</li>
</ol>
<h2 id="restoring-files">Restoring Files</h2>
<p>The file restoration worker performs the following tasks:</p>
<ol>
<li>After receiving the WorkItem ID from NSQ, it retrieves the WorkItem from Pharos.</li>
<li>The worker retrieves the GenericFile record from Pharos of the file to be restored.</li>
<li>The worker copies the file directly from preservation storage to the depositor's receiving bucket.</li>
<li>The worker marks the WorkItem complete, and includes in the WorkItem note the URL from which the depositor may retrieve the file.</li>
<li>The worker marks the NSQ message as finished.</li>
</ol>
<h2 id="restoring-objects">Restoring Objects</h2>
<p>Object restoration is more complex, since restoring an object requires retrieving and packaging multiple files before sending the entire restored package to the depositor's restoration bucket.</p>
<p>The object restoration worker performs the following tasks:</p>
<ol>
<li>After receiving the WorkItem ID from NSQ, it retrieves the WorkItem from Pharos.</li>
<li>The worker retrieves the IntellectualObject record from Pharos of the object to be restored.</li>
<li>The worker retrieves each GenericFile record belonging to that object from Pharos.</li>
<li>For each active GenericFile (where state = "A" and not "D"), the worker copies the file from preservation storage to a staging area for bagging. Note that, other than bagit.txt, APTrust preserves tag files in addition to payload files.</li>
<li>The worker validates the actual checksums of each file during the download to staging. If any file cannot be found, or if any file's checksum does not match the most recent checksum in Pharos, the restoration fails.</li>
<li>The worker bags all of the files (including perserved tag files) according to the profile used when the bag was initially ingested. The profile information is part of the IntellectualObject record, and may be APTrust or Beyond the Repository (BTR). As part of the bagging process, the restoration worker creates manifests and tag manifests.</li>
<li>The worker requests a list from Pharos of all PREMIS events pertaining to this object. It includes this list in the bag as a JSON file. The primary reason for this is so depositors can see that some items in the bag may have been deleted or re-ingested while APTrust had custody of the object.</li>
<li>The worker validates the bag.</li>
<li>The worker copies the bag to the depositor's receiving bucket.</li>
<li>The worker marks the WorkItem complete, and includes in the WorkItem note the URL from which the depositor may retrieve the file.</li>
<li>The worker marks the NSQ message as finished.</li>
</ol>
<p>Note that because APTrust rebags objects when it restores them, the restored bag will not be byte-for-byte identical to the initially ingested bag. We do guarantee that the payload will be complete, and that the new bag will include the tag files from the original (except for bagit.txt, which we reconstitute), the restored bag can have the following differences:</p>
<ol>
<li>Items in the manifest may be listed in a different order than the original.</li>
<li>The restored bag may include additional manifests or tag manifests not present in the original bag.</li>
<li>The restored bag will not include files that were deleted during the object's time in APTrust's custody.</li>
</ol>
<h2 id="restoring-from-glacier">Restoring from Glacier</h2>
<p>Glacier restorations follow the steps outlined above for files and objects, with these additional steps at the beginning:</p>
<ol>
<li>The WorkItem IDs of Glacier items first go into an NSQ topic called <code>apt_glacier_restore_init</code>.</li>
<li>The <code>apt_glacier_restore_init</code> worker issues one Glacier restore request per file to the vault holding the files.</li>
<li>The worker checks the status of the restore requests every few hours.</li>
<li>When all Glacier files have been copied to S3, the Glacier restore worker pushes the WorkItem ID into the normal NSQ restoration topic. From there, the restoration proceeds as described above.</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../deletion/" title="Deletion" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deletion
              </span>
            </div>
          </a>
        
        
          <a href="../../scaling/" title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Overview
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>